/*! PROJECT_NAME - v0.1.0 - 2012-06-04
* http://PROJECT_WEBSITE/
* Copyright (c) 2012 Mike Ringrose; Licensed MIT */
var y=yarn={};yarn.LatLng=function(){function a(a,b){this.lat=a,this.lng=b}return a}(),yarn.Point=function(){function a(a,b){this.x=a,this.y=b}return a.prototype={subtract:function(b){return new a(this.x-b.x,this.y-b.y)}},a}(),yarn.Map=function(){function a(a){var b=a.el.clientWidth,c=a.el.clientHeight,d=y.proj.Projection.get(a.projection||"spherical mercator");this.model=new yarn.models.Map({tileSize:a.tileSize,zoom:a.zoom,center:a.center,projection:d,dimensions:{width:b,height:c},width:b,height:c}),this.view=new yarn.views.Map({el:a.el,model:this.model}),this.view.render()}return a.prototype={zoomIn:function(){var a=this.model.get("zoom");return this.setZoom(a+1)},zoomOut:function(){var a=this.model.get("zoom");return this.setZoom(a-1)},setZoom:function(a){var b=this.model.get("minZoom"),c=this.model.get("maxZoom");return this.model.set({zoom:a<b?b:a>c?c:a}),this},setCenter:function(a){return this.model.set({center:a}),this}},a}(),yarn.proj={},yarn.proj.Projection=function(){return{get:function(a){var b;return"spherical mercator"===a&&(b=new yarn.proj.SphericalMercator),b}}}(),yarn.proj.SphericalMercator=function(){function e(){}var a=Math.PI/180,b=180/Math.PI,c=6378137,d={x:20037508.34,y:20037508.34};return e.prototype={getResolution:_.memoize(function(a,b){return 2*d.x/(Math.pow(2,a)*b)}),project:function(b){var c=d.x/Math.PI,e=b.lat*a,f=b.lng*a*c,g=Math.log(Math.tan(e)+1/Math.cos(e))*c;return new yarn.Point(f,g)},unproject:function(a){var c=d.y/Math.PI,e=b*(2*Math.atan(Math.exp(a.y/c))-Math.PI/2),f=a.x/c*b;return new yarn.LatLng(e,f)}},e}(),yarn.models={},yarn.models.Viewport=Backbone.Model.extend({defaults:{top:0,left:0,right:0,bottom:0,transformer:null},getTopLeft:function(){var a=this.get("transform");return a(new yarn.Point(this.get("left"),this.get("top")))},getBottomRight:function(){var a=this.get("transform");return a(new yarn.Point(this.get("right"),this.get("bottom")))}}),function(){yarn.models.Map=Backbone.Model.extend({defaults:{tileSize:256,projection:"spherical mercator",zoom:null,minZoom:1,maxZoom:18,center:null,viewport:null},initialize:function(a){var b=this;b.set({viewport:b.calculateViewport(b,b.get("zoom"))}),b.on("change:zoom",function(a,c){b.set({viewport:this.calculateViewport(a,c)})}),b.on("change:center",function(a,b){})},updateViewport:function(a,b){},calculateViewport:function(a,b){var c=a.get("center"),d=a.get("projection"),e=a.get("tileSize"),f=d.project(c),g=d.getResolution(b,e),h=a.get("width")/2*g,i=a.get("height")/2*g;return new yarn.models.Viewport({top:f.y+i,left:f.x-h,right:f.x+h,bottom:f.y-i,transform:function(a){return px=(a.x+20037508.34)/g,py=(-a.y+20037508.34)/g,new yarn.Point(px,py)}})}})}(),yarn.views={},function(){yarn.views.Map=Backbone.View.extend({events:{mousedown:"dragStart",mousemove:"drag",mouseup:"dragEnd"},initialize:function(a){this.layer=new yarn.views.TileLayer({model:this.model})},render:function(){this.el.appendChild(this.layer.render().el)},dragStart:function(a){this.dragPoint=new yarn.Point(a.clientX,a.clientY)},dragEnd:function(a){this.dragPoint=null},drag:function(a){if(!this.dragPoint)return;var b=this.dragPoint,c=new yarn.Point(a.clientX,a.clientY),d=c.subtract(b),e=this.$el.offset();this.dragPoint=c}})}(),function(){yarn.views.TileLayer=Backbone.View.extend({initialize:function(a){var b=this;b.tiles=[],_.bindAll(b,"render"),b.model.on("change:viewport",b.render)},render:function(){var a=this.model,b=a.get("viewport");return this._addTiles(b),this},calculateTopLeft:function(a,b){var c=a.getTopLeft();return new yarn.Point(c.x/b,c.y/b)},_addTiles:function(){var a=this.model.get("viewport"),b=this.model.get("zoom"),c=this.model.get("width"),d=this.model.get("height"),e=this.model.get("tileSize"),f=this.model.get("dimensions"),g=this.calculateTopLeft(a,e),h=currX=Math.floor(g.x),i=Math.floor(g.y),j=currLeft=-1*Math.floor((g.x-h)*e),k=-1*Math.floor((g.y-i)*e),l;while(k<f.height){while(currLeft<f.width)l=new yarn.views.Tile({src:"http://otile1.mqcdn.com/tiles/1.0.0/osm/"+b+"/"+currX+"/"+i+".png",top:k,left:currLeft}),this.$el.append(l.render().el),currX+=1,currLeft+=e;k+=256,i+=1,currX=h,currLeft=j}}})}(),function(){var a=function(){var a=document.createElement("img");return a.style.position="absolute",a.draggable=!1,a}();yarn.views.Tile=Backbone.View.extend({initialize:function(a){this.src=a.src,this.top=a.top,this.left=a.left},dispose:function(){var a=this.el,b=a.parentNode;a.src=null,b.removeChild(a)},render:function(){var b=a.cloneNode(!1);return b.src=this.src,b.style.top=this.top+"px",b.style.left=this.left+"px",this.el=b,this}})}();