/*! PROJECT_NAME - v0.1.0 - 2012-10-20
* http://PROJECT_WEBSITE/
* Copyright (c) 2012 Mike Ringrose; Licensed MIT */
var yarn={},y=yarn;yarn.LatLng=function(){function a(a,b){this.lat=a,this.lng=b}return a}(),yarn.Point=function(){function a(a,b){this.x=a,this.y=b}return a.prototype={add:function(b){return new a(this.x+b.x,this.y+b.y)},subtract:function(b){return new a(this.x-b.x,this.y-b.y)},multiply:function(b){return new a(this.x*b,this.y*b)},divide:function(b){return new a(this.x/b,this.y/b)},floor:function(){return new a(Math.floor(this.x),Math.floor(this.y))}},a}(),yarn.Map=function(){function a(a){var b=a.el.clientWidth,c=a.el.clientHeight,d=y.proj.Projection.get(a.projection||"spherical mercator");this.model=new yarn.models.Map({tileSize:a.tileSize,zoom:a.zoom,center:a.center,projection:d,dimensions:{width:b,height:c},width:b,height:c}),this.view=new yarn.views.Map({el:a.el,model:this.model}),this.view.render()}return a.prototype={zoomIn:function(){var a=this.model.get("zoom");return this.setZoom(a+1)},zoomOut:function(){var a=this.model.get("zoom");return this.setZoom(a-1)},setZoom:function(a){var b=this.model.get("minZoom"),c=this.model.get("maxZoom");return this.model.set({zoom:a<b?b:a>c?c:a}),this},setCenter:function(a){return this.model.set({center:a}),this}},a}(),yarn.proj={},yarn.proj.Projection=function(){return{get:function(a){var b;return"spherical mercator"===a&&(b=new yarn.proj.SphericalMercator),b}}}(),yarn.proj.SphericalMercator=function(){function e(){}var a=Math.PI/180,b=180/Math.PI,c=6378137,d=new yarn.Point(20037508.34,20037508.34);return e.prototype={getResolution:_.memoize(function(a,b){return 2*d.x/(Math.pow(2,a)*b)}),getTransformer:function(a,b){var c=this.getResolution(a,b);return{forward:function(a){return a.add(d).divide(c)},reverse:function(a){return a.multiply(c)}}},project:function(b){var c=d.x/Math.PI,e=b.lat*a,f=b.lng*a*c,g=Math.log(Math.tan(e)+1/Math.cos(e))*c;return new yarn.Point(f,g)},unproject:function(a){var c=d.y/Math.PI,e=b*(2*Math.atan(Math.exp(a.y/c))-Math.PI/2),f=a.x/c*b;return new yarn.LatLng(e,f)}},e}(),yarn.models={},yarn.models.Viewport=Backbone.Model.extend({defaults:{topLeft:null,bottomRight:null,transformer:null},getTopLeft:function(){var a=this.get("transform");return a(this.get("topLeft"))},getBottomRight:function(){var a=this.get("transform");return a(this.get("bottomRight"))}}),function(){yarn.models.Map=Backbone.Model.extend({defaults:{tileSize:256,projection:"spherical mercator",zoom:null,minZoom:1,maxZoom:18,center:null,viewport:null},initialize:function(a){var b=this;b.set({viewport:b.calculateViewport(b,b.get("zoom"))}),b.on("change:zoom",function(a,c){b.set({viewport:this.calculateViewport(a,c)})}),b.on("change:center",function(a,b){this.updateViewport(a,b)})},zoomIn:function(){var a=this.get("zoom"),b=this.get("maxZoom");a+=1,a<b&&this.set({zoom:a})},updateViewport:function(a,b){var c=this.get("viewport"),d=this.project(b),e=this.getHalfDimensionsMercator();c.set({topLeft:new yarn.Point(d.x-e.x,d.y+e.y),bottomRight:new yarn.Point(d.x+e.x,d.y-e.y)})},calculateViewport:function(a,b){var c=a.get("center"),d=this.getResolution(a),e=this.project(c),f=this.getHalfDimensionsMercator();return new yarn.models.Viewport({topLeft:new yarn.Point(e.x-f.x,e.y+f.y),bottomRight:new yarn.Point(e.x+f.x,e.y-f.y),transform:function(a){var b=(a.x+20037508.34)/d,c=(-a.y+20037508.34)/d;return new yarn.Point(b,c)}})},moveByPixels:function(a){var b=this.get("center"),c=this.reverse(a),d=this.project(b).subtract(c);this.set({center:this.unproject(d)})},getProjection:function(){return this.get("projection")},getResolution:function(a){var b=a.get("zoom"),c=a.get("tileSize"),d=a.get("projection");return d.getResolution(b,c)},getHalfDimensionsMercator:function(){var a=this.get("projection"),b=a.getTransformer(this.get("zoom"),this.get("tileSize")),c=(new yarn.Point(this.get("width"),this.get("height"))).divide(2);return b.reverse(c)},project:function(a){var b=this.get("projection");return b.project(a)},unproject:function(a){var b=this.get("projection");return b.unproject(a)},transformLatLngToPixels:function(a){var b=this.getProjection(),c=b.getTransformer(this.get("zoom"),this.get("tileSize")),d=b.project(a);return c.forward(d)},reverse:function(a){var b=this.get("projection"),c=b.getTransformer(this.get("zoom"),this.get("tileSize"));return c.reverse(a)}})}(),yarn.Clickable=function(){return{events:{dblclick:"zoomIn"},zoomIn:function(a){this.model.zoomIn()}}}(),yarn.Draggable=function(){return{events:{mousedown:"dragStart",mouseup:"dragStop",mousemove:"drag"},dragStart:function(a){this.dragging=!0,this.$el.css("cursor","move"),this.dragStartX=a.pageX,this.dragStartY=a.pageY},dragStop:function(a){this.dragging=!1,this.$el.css("cursor","auto")},drag:function(a){var b,c;this.dragging&&(c=new yarn.Point(a.pageX-this.dragStartX,this.dragStartY-a.pageY),this.model.moveByPixels(c),this.dragStartX=a.pageX,this.dragStartY=a.pageY)}}}(),yarn.views={},function(){yarn.views.Map=Backbone.View.extend({mixins:[yarn.Clickable,yarn.Draggable],background:"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAIAAACQkWg2AAAAKklEQVQokWO8du0aAzZw+fJlrOJMWEXxgFENxAAWXOGtq6tLHRtGNRADALj3CB2z8pZoAAAAAElFTkSuQmCC')",events:{},initialize:function(a){var b=this;_.bindAll(b),this.model.on("change:center",this.update),this.model.on("change:zoom",this.reset),this.layer=new yarn.views.TileLayer({model:this.model})},render:function(){var a=this,b=a.layers=$('<div style="position: absolute"></div>');this.$el.css("background-image",this.background),a.$el.append(b),b.append(this.layer.render().el)},update:function(a,b){var c=a.previous("center"),d=a.transformLatLngToPixels(b),e=a.transformLatLngToPixels(c),f=e.subtract(d);this.move(f)},move:function(a){var b=this.layers.position();this.layers.css("top",b.top-a.y),this.layers.css("left",b.left+a.x)},reset:function(){this.layers.css("top",0),this.layers.css("left",0)}})}(),function(){yarn.views.TileLayer=Backbone.View.extend({initialize:function(a){var b=this,c=b.model,d=c.get("viewport");b.tiles={},b.origin=d.getTopLeft(),_.bindAll(b,"render","_reset","_move"),b.model.on("change:center",b._move),b.model.on("change:zoom",b._reset)},render:function(){var a=this.model,b=a.get("viewport");return this.$el.css("position","relative"),this._tile(a),this},_reset:function(a,b){var c=a.get("viewport");_.invoke(this.tiles,"dispose"),this.tiles={},this.origin=c.getTopLeft(),this._tile(a)},_move:function(a,b){this._tile(a)},_tile:function(a){var b=a.get("zoom"),c=a.get("viewport"),d=a.get("tileSize"),e=this._calculateTopLeft(),f=e.multiply(d),g=c.getBottomRight(),h=[],i,j,k,l,m,n;for(i=f.y,l=e.y;i<=g.y;i+=d,l+=1)for(j=f.x,k=e.x;j<=g.x;j+=d,k+=1)m=b+"/"+k+"/"+l,this.tiles[m]||(n=this._createTile(m,this._getTileTopLeft(i,j)),h.push(n),this.tiles[m]=n);this._addTiles(h)},_addTiles:function(a){var b;while(b=a.pop())this.$el.append(b.render().el)},_getTileTopLeft:function(a,b){var c=new yarn.Point(b,a);return c.subtract(this.origin)},_createTile:function(a,b){return new yarn.views.Tile({src:"http://otile1.mqcdn.com/tiles/1.0.0/osm/"+a+".png",topLeft:b})},_calculateTopLeft:function(){var a=this.model,b=a.get("viewport"),c=a.get("tileSize");return b.getTopLeft().divide(c).floor()}})}(),function(){var a=function(){var a=document.createElement("img");return a.style.position="absolute",a.draggable=!1,a}();yarn.views.Tile=Backbone.View.extend({initialize:function(a){this.src=a.src,this.topLeft=a.topLeft},dispose:function(){var a=this.el,b=a.parentNode;a.src=null,b.removeChild(a)},render:function(){var b=a.cloneNode(!1);return b.src=this.src,b.style.top=this.topLeft.y+"px",b.style.left=this.topLeft.x+"px",this.el=b,this},update:function(a,b){var c=this.el;c.style.top=this.top+"px",c.style.left=this.left+"px"}})}();